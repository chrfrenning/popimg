<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snap and Share Photos | LiveWall Camera</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            overflow: hidden;
        }

        #camera-container {
            position: relative;
            width: 100vw;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #capture-button {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            background-color: lightblue;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        #switch-camera-button {
            position: absolute;
            bottom: 5%;
            left: calc(50% + 50px);
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            background-color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 9;
        }

        #canvas {
            display: none;
        }

        .fas {
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div id="camera-container">
        <video id="video" autoplay playsinline></video>
        <button id="capture-button"></button>
        <button id="switch-camera-button"><i class="fas fa-sync-alt"></i></button>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        let currentCameraIndex = 0;
        let stream = null;
        let mediaDevices = [];
        let isFrontCamera = true;

        async function initCamera(cameraIndex = 0, facingMode = 'environment') {
            try {
                // First request permission to access camera
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                mediaDevices = devices.filter(device => device.kind === 'videoinput');

                if (mediaDevices.length === 0) {
                    console.error('No camera devices found.');
                    return;
                }

                // Show the switch button if there are multiple cameras
                if (mediaDevices.length > 1) {
                    setTimeout(() => {
                        document.getElementById('switch-camera-button').style.display = 'block';
                    }, 500); // Delay to account for permission prompts on iOS
                }

                if (stream) {
                    // Stop all active tracks before switching
                    stream.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 4096 },
                        height: { ideal: 2160 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = stream;
            } catch (err) {
                console.error('Error accessing camera: ', err);
            }
        }

        function adjustViewportHeight() {
            const cameraContainer = document.getElementById('camera-container');
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            cameraContainer.style.height = `calc(var(--vh, 1vh) * 100)`;
        }

        function capture() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            const cameraContainer = document.getElementById('camera-container');

            // Set canvas dimensions to what is actually visible on the screen
            canvas.width = cameraContainer.clientWidth;
            canvas.height = cameraContainer.clientHeight;
            
            // Calculate the aspect ratio to clip the video properly
            const videoAspectRatio = video.videoWidth / video.videoHeight;
            const canvasAspectRatio = canvas.width / canvas.height;
            let sx, sy, sWidth, sHeight;

            if (canvasAspectRatio > videoAspectRatio) {
                // Canvas is wider than the video, clip vertically
                sWidth = video.videoWidth;
                sHeight = video.videoWidth / canvasAspectRatio;
                sx = 0;
                sy = (video.videoHeight - sHeight) / 2;
            } else {
                // Canvas is taller than the video, clip horizontally
                sWidth = video.videoHeight * canvasAspectRatio;
                sHeight = video.videoHeight;
                sx = (video.videoWidth - sWidth) / 2;
                sy = 0;
            }

            // Draw only the visible part of the video onto the canvas
            context.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);
        }

        function postCanvasToServer() {
            const canvas = document.getElementById('canvas');
            canvas.toBlob((blob) => {
                if (blob) {
                    const reader = new FileReader();
                    reader.readAsArrayBuffer(blob);
                    reader.onloadend = () => {
                        // get the w query string parameter
                        const urlParams = new URLSearchParams(window.location.search);
                        const w = urlParams.get('w') || '0';

                        const byteArray = new Uint8Array(reader.result);
                        
                        fetch('/w/' + w, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'image/webp'
                            },
                            body: byteArray
                        });
                    };
                }
            }, 'image/webp', 0.6);
        }

        const captureButton = document.getElementById('capture-button');
        captureButton.addEventListener('click', () => {
            capture();
            postCanvasToServer();
        });

        const switchCameraButton = document.getElementById('switch-camera-button');
        switchCameraButton.addEventListener('click', () => {
            isFrontCamera = !isFrontCamera;
            const facingMode = isFrontCamera ? 'user' : 'environment';
            initCamera(0, facingMode);
        });
        
        window.addEventListener('load', () => {
            initCamera();
            adjustViewportHeight();
        });
        window.addEventListener('resize', adjustViewportHeight);
    </script>
</body>
</html>
